{% extends 'base.html' %} {% block content %} {% load static %}
<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
<script>
    var handler = '';
    task_id = '';
    task_name = '';
    intervalVar = null;

    function listFiles() {
        $("#task_loader").show();
        console.log('listFiles...')
        let path = "{{args.api_url}}" + '/api/files'
        task_name = 'listFiles'

        $.ajax({
            method: 'GET',
            url: path,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(res) {
                intervalVar = setInterval(function() {
                    try {
                        checkTaskResult(res.task_id)
                    } catch (e) {
                        console.log(e)
                    }
                }, 5000)
            },
            error: function(err) {
                //show error msg
                console.log(err)
                $("#error").html("Could not list files. Request failed!")
                $('#error').css('display', 'block')
                $("#file_buttons").css('display', 'block')
            }
        });
    };

    function get_file() {
        $("#task_loader").show();
        console.log("getfile...")
        let filename = document.getElementById("filename_input").value;
        let path = "{{args.api_url}}" + '/api/files?filename=' + filename
        task_name = 'get_file'

        $.ajax({
            method: 'GET',
            url: path,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(res) {
                intervalVar = setInterval(function() {
                    try {
                        checkTaskResult(res.task_id)
                    } catch (e) {
                        console.log(e)
                    }
                }, 5000)
            },
            error: function(err) {
                console.log(err)
                $("#error").html("Could not list files. Request failed!")
                $('#error').css('display', 'block')
                $("#file_buttons").css('display', 'block')
            }
        });
    };

    function checkTaskResult(tasknumber) {
        let path = "{{args.api_url}}" + '/api/task/result?task=' + tasknumber

        $.ajax({
            method: 'GET',
            url: path,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === "SUCCESS") {
                    $("#info").html("Task completed successfully.")
                    $('#info').css('display', 'block')
                    $("#file_buttons").css('display', 'block')
                    console.log(data.result)
                    task_id = data.task_id

                    let hidden = document.getElementById("result_button")
                    hidden.style.display = "block";

                    clearInterval(intervalVar)
                } else if (data.status === "FAILURE" || data.status === "REVOKED") {
                    $("#error").html("Task Failed or Revoked!")
                    $('#error').css('display', 'block')
                    $("#file_buttons").css('display', 'block')
                    clearInterval(intervalVar)
                } else {
                    // $("#progressbar").progressbar({ value: 30 });
                }
                $("#task_loader").hide();
            },
            error: function(err) {
                console.log(err)
                $("#error").html("Could not validate task result. Request failed!")
                $('#error').css('display', 'block')
                clearInterval(intervalVar)
            }
        })
    }

    function showResult() {
        var url = ''
        if (task_name === "listFiles") {
            var url = "{% url 'frontend:file_list' %}";
        } else if (task_name === 'get_file') {
            var url = "{% url 'frontend:file_view' %}";
        } else {
            console.log('Invalid task')
            return;
        }
        document.location.href = url + "?task=" + task_id
    }

    function showFileSearchForm() {
        document.getElementById("view_file_div").style.display = "block"
    }

    function createFile() {
        $("#createFileForm").show();
    }
</script>

<style>
    * {
        box-sizing: border-box
    }
    
    #result_button {
        display: none;
    }
    
    .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 150px;
        height: 150px;
        -webkit-animation: spin 1s linear infinite;
        /* Safari */
        animation: spin 1s linear infinite;
        margin: 0 auto;
        position: absolute;
        top: 50%;
        left: 50%;
        margin: -75px 0 0 -75px;
    }
    /* Safari */
    
    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }
    
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
    /* Style the tab */
    
    .tab {
        float: left;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        width: 30%;
        height: 300px;
    }
    /* Style the buttons inside the tab */
    
    .tab button {
        display: block;
        background-color: inherit;
        color: black;
        padding: 22px 16px;
        width: 100%;
        border: none;
        outline: none;
        text-align: left;
        cursor: pointer;
        transition: 0.3s;
        font-size: 17px;
    }
    /* Change background color of buttons on hover */
    
    .tab button:hover {
        background-color: #ddd;
    }
    /* Create an active/current "tab button" class */
    
    .tab button.active {
        background-color: #ccc;
    }
    /* Style the tab content */
    
    .tabcontent {
        float: left;
        padding: 0px 12px;
        border: 1px solid #ccc;
        width: 70%;
        border-left: none;
        height: 300px;
    }
    
    #view_file_div {
        display: none;
    }
</style>

<div style="padding-left:16px">
    <h2>Files</h2>
</div>

<div>
    Files are located in an external store. To safe you some time, we don't load all the files from the storage. <br> You can either request a list of all files or request the content of a specific one. Of course it is also possibile to create a new file.
    <br>
</div>
<br>
<div class="tab" id="file_buttons">
    <button class="tablinks" id="list_files_button" onClick="listFiles()">List all files</button>
    <button onclick="showFileSearchForm()">View file</button>
    <form>
        <button class="tablinks" formaction="{% url 'frontend:file_create' %}">Create new file</button>
    </form>
    <form>
        <button class="tablinks" onclick="createFile()">Create new file</button>
    </form>
</div>

<div class="tabcontent">
    <div style="display:none" id='task_loader' class="loader"></div>
    <div id="view_file_div">
        <form class="tablinks" id='filename_form' method="get">
            File: <input id='filename_input' type="text" name="file" id="file">
        </form>
        <button id='getFile_button' onclick="get_file()">View file</button>
    </div>
    <div id="result_button">
        <button onclick="showResult()">Show Result</button>
    </div>
    <div style="display:none" id="createFileForm">
        <form method="post">
            {% csrf_token %} {{ form.as_p }}
            <input type="submit" value="Save">
        </form>
    </div>
</div>





{% endblock %}